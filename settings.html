<div id="sidecar_ai_settings" class="sidecar_ai_settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>Sidecar AI</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            <div class="sidecar_settings_content">
                <p class="add_ons_description">Define custom prompts that execute using cheaper AI models.</p>
                
                <div class="add_ons_controls">
                    <div class="add_ons_controls_left">
                        <button class="menu_button" id="sidecar_create_button">
                            <i class="fa-solid fa-plus"></i> Create Sidecar
                        </button>
                    </div>
                    <div class="add_ons_controls_right">
                        <button class="menu_button add_ons_button_small" id="sidecar_export_button" title="Export All Add-ons">
                            <i class="fa-solid fa-download"></i> Export
                        </button>
                        <button class="menu_button add_ons_button_small" id="sidecar_import_button" title="Import Add-ons">
                            <i class="fa-solid fa-upload"></i> Import
                        </button>
                    </div>
                </div>

                <div class="add_ons_list" id="add_ons_list">
                    <!-- Add-ons will be rendered here by JavaScript -->
                    <div class="add_ons_empty">
                        <p>No Sidecars configured. Click "Create Sidecar" to create one.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Form Modal -->
    <div class="add_ons_modal" id="add_ons_modal" style="display: none;">
        <div class="add_ons_modal_content">
            <div class="add_ons_modal_header">
                <h3 id="add_ons_modal_title">Create New Sidecar</h3>
                <button class="add_ons_modal_close" id="add_ons_modal_close">&times;</button>
            </div>
            <div class="add_ons_modal_body">
                <form id="add_ons_form">
                    <input type="hidden" id="add_ons_form_id" name="id">

                    <div class="add_ons_form_group">
                        <label for="add_ons_form_name">Name *</label>
                        <input type="text" id="add_ons_form_name" name="name" class="text_pole" required placeholder="e.g., Gemini Nazi Module">
                    </div>

                    <div class="add_ons_form_group">
                        <label for="add_ons_form_description">Description</label>
                        <textarea id="add_ons_form_description" name="description" class="text_pole" rows="2" placeholder="Brief description of what this Sidecar does"></textarea>
                    </div>

                    <div class="add_ons_form_group">
                        <label for="add_ons_form_prompt">Prompt / Instruction *</label>
                        <textarea id="add_ons_form_prompt" name="prompt" class="text_pole" rows="8" required placeholder="Enter your instruction here. Context (chat history, character card, user card, world card) will be automatically included based on settings below."></textarea>
                        <small class="add_ons_form_hint">Just write your instruction. All necessary context (chat history, cards) will be automatically included based on the checkboxes below.</small>
                    </div>

                    <div class="add_ons_form_row">
                        <div class="add_ons_form_group">
                            <label for="add_ons_form_trigger_mode">Trigger Mode *</label>
                            <select id="add_ons_form_trigger_mode" name="triggerMode" class="text_pole" required>
                                <option value="auto">Auto (after each AI response)</option>
                                <option value="manual">Manual (triggered by button)</option>
                            </select>
                        </div>

                        <div class="add_ons_form_group">
                            <label for="add_ons_form_request_mode">Request Mode *</label>
                            <select id="add_ons_form_request_mode" name="requestMode" class="text_pole" required>
                                <option value="standalone">Standalone</option>
                                <option value="batch">Batch (group with same provider/model)</option>
                            </select>
                        </div>
                    </div>

                    <div class="add_ons_form_row">
                        <div class="add_ons_form_group">
                            <label for="add_ons_form_ai_provider">AI Provider *</label>
                            <select id="add_ons_form_ai_provider" name="aiProvider" class="text_pole" required>
                                <option value="openai">OpenAI</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="custom">Custom / Local (OpenAI Compatible)</option>
                            <option value="deepseek">Deepseek</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="google">Google (Gemini)</option>
                                <option value="cohere">Cohere</option>
                            </select>
                        </div>

                    <div class="add_ons_form_group">
                        <label for="add_ons_form_ai_model">AI Model *</label>
                        <select id="add_ons_form_ai_model" name="aiModel" class="text_pole" required>
                            <option value="">Select a model...</option>
                        </select>
                        <small class="add_ons_form_hint" id="add_ons_model_hint">Models will load based on selected provider</small>
                    </div>
                </div>

                <div class="add_ons_form_row" id="add_ons_service_provider_row" style="display: none;">
                    <div class="add_ons_form_group" style="grid-column: 1 / -1;">
                        <label for="add_ons_form_service_provider">Service Provider (OpenRouter only)</label>
                        <select id="add_ons_form_service_provider" name="serviceProvider" class="text_pole" multiple>
                            <!-- Options will be populated dynamically from SillyTavern's OpenRouter providers -->
                        </select>
                        <small class="add_ons_form_hint">Select one or more service providers (e.g., Chutes, Nvidia, Parasails). Leave empty to use all providers.</small>
                    </div>
                </div>

                <div class="add_ons_form_row" id="add_ons_api_url_row">
                    <div class="add_ons_form_group">
                        <label for="add_ons_form_api_url">API URL (Optional)</label>
                        <input type="text" id="add_ons_form_api_url" name="apiUrl" class="text_pole" placeholder="Default for provider if empty">
                        <small class="add_ons_form_hint">Required for Custom/Local providers. Overrides default endpoint.</small>
                    </div>
                </div>

                <div class="add_ons_form_row" id="add_ons_api_key_row">
                    <div class="add_ons_form_group" style="grid-column: 1 / -1;">
                        <label for="add_ons_form_api_key">API Key *</label>
                        <div style="display: flex; gap: 8px; align-items: stretch;">
                            <input type="password" id="add_ons_form_api_key" name="apiKey" class="text_pole" required placeholder="Enter your API key" style="flex: 1; min-width: 0;">
                            <button type="button" class="menu_button add_ons_button_small" id="add_ons_test_connection" title="Test API connection">Test Connection</button>
                        </div>
                        <small class="add_ons_form_hint">API key is saved securely in extension settings. Test connection before saving.</small>
                    </div>
                </div>

                <div class="add_ons_form_row">
                    <div class="add_ons_form_group">
                        <label for="add_ons_form_result_format">Result Format *</label>
                        <select id="add_ons_form_result_format" name="resultFormat" class="text_pole" required>
                            <option value="append">Append (inline)</option>
                            <option value="separate">Separate Block</option>
                            <option value="collapsible" selected>Collapsible</option>
                        </select>
                    </div>

                    <div class="add_ons_form_group">
                        <label for="add_ons_form_response_location">Response Location *</label>
                        <select id="add_ons_form_response_location" name="responseLocation" class="text_pole" required>
                            <option value="chatHistory">Chat History (HTML comment, accessible to main AI)</option>
                            <option value="outsideChatlog" selected>Outside Chatlog (dropdown below chat)</option>
                        </select>
                        <small class="add_ons_form_hint" id="add_ons_response_location_hint">
                            Results appear in expandable dropdown below chat area
                        </small>
                    </div>
                </div>

                <div class="add_ons_form_row">
                    <div class="add_ons_form_group" style="grid-column: 1 / -1;">
                        <label for="add_ons_form_format_style">Format Style</label>
                        <select id="add_ons_form_format_style" name="formatStyle" class="text_pole">
                            <option value="markdown" selected>Markdown (default)</option>
                            <option value="html-css">HTML + CSS</option>
                            <option value="xml">XML</option>
                            <option value="beautify">Random Beautify âœ¨</option>
                        </select>
                        <small class="add_ons_form_hint">
                            Choose how the AI should format its response. HTML+CSS uses safe, theme-compatible styles. XML formats as structured XML. Random Beautify applies various decorative styles.
                        </small>
                    </div>
                </div>

                    <div class="add_ons_form_section">
                        <h4>Add-on History</h4>
                        <div class="add_ons_form_checkboxes">
                            <label class="add_ons_checkbox checkbox_label" title="Enable history for this add-on to remember its previous outputs">
                                <input type="checkbox" id="add_ons_form_include_history" name="includeHistory">
                                <span>Include previous results history</span>
                            </label>
                        </div>
                        <div class="add_ons_form_group" id="add_ons_history_depth_group" style="display: none; margin-top: 10px;">
                            <label for="add_ons_form_history_depth">History Depth</label>
                            <input type="number" id="add_ons_form_history_depth" name="historyDepth" class="text_pole" min="1" max="20" value="5">
                            <small class="add_ons_form_hint">Number of previous results from this specific add-on to include in context.</small>
                        </div>
                    </div>

                    <div class="add_ons_form_section">
                        <h4>Context Settings</h4>
                        
                        <div class="add_ons_form_group">
                            <label for="add_ons_form_messages_count">Number of Messages</label>
                            <input type="number" id="add_ons_form_messages_count" name="messagesCount" class="text_pole" min="1" max="50" value="10">
                        </div>

                        <div class="add_ons_form_checkboxes">
                            <label class="add_ons_checkbox checkbox_label" title="Include character card data in the context sent to AI">
                                <input type="checkbox" id="add_ons_form_include_char_card" name="includeCharCard" checked>
                                <span>Include Character Card</span>
                            </label>
                            <label class="add_ons_checkbox checkbox_label" title="Include user card data in the context sent to AI">
                                <input type="checkbox" id="add_ons_form_include_user_card" name="includeUserCard" checked>
                                <span>Include User Card</span>
                            </label>
                            <label class="add_ons_checkbox checkbox_label" title="Include world card data in the context sent to AI">
                                <input type="checkbox" id="add_ons_form_include_world_card" name="includeWorldCard" checked>
                                <span>Include World Card</span>
                            </label>
                        </div>
                        <small class="add_ons_form_hint">These checkboxes control which context data is automatically included. Chat history is always included based on "Number of Messages" above.</small>
                    </div>
                </form>
            </div>
            <div class="add_ons_modal_footer">
                <button class="menu_button" id="add_ons_form_cancel">Cancel</button>
                <button class="menu_button" id="add_ons_form_save">Save Sidecar</button>
            </div>
        </div>
    </div>

    <!-- History Viewer Modal -->
    <div class="add_ons_modal" id="add_ons_history_modal" style="display: none;">
        <div class="add_ons_modal_content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="add_ons_modal_header">
                <h3 id="add_ons_history_modal_title">Result History</h3>
                <button class="add_ons_modal_close" id="add_ons_history_modal_close">&times;</button>
            </div>
            <div class="add_ons_modal_body">
                <div id="add_ons_history_filters" style="margin-bottom: 15px; padding: 10px; background: rgba(128, 128, 128, 0.1); border-radius: 5px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="add_ons_history_search" class="text_pole" placeholder="Search results..." style="flex: 1; min-width: 200px;">
                        <select id="add_ons_history_sort" class="text_pole" style="width: 150px;">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                        <button class="menu_button add_ons_button_small" id="add_ons_history_clear_filters">
                            <i class="fa-solid fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                <div id="add_ons_history_list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- History items will be rendered here -->
                </div>
            </div>
            <div class="add_ons_modal_footer">
                <button class="menu_button" id="add_ons_history_close">Close</button>
            </div>
        </div>
    </div>
</div>

